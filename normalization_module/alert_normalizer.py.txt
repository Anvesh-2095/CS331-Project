import json
import os
import uuid
from datetime import datetime, timezone

from .alert_model import NormalizedAlert


p = os.path.join(os.path.dirname(__file__), "normalization_rules.json")
with open(p, "r", encoding="utf-8") as f:
    r = json.load(f)

sev_map = r.get("severity_map", {})
src_rules = r.get("sources", {})


def _pick(a, ks):
    for k in ks:
        if k in a and a[k] not in (None, ""):
            return a[k]
    return None


def _src(a):
    x = " ".join(
        [
            str(a.get("source", "")).lower(),
            str(a.get("tool", "")).lower(),
            str(a.get("product", "")).lower(),
        ]
    )

    if "snort" in x or "suricata" in x or "ids" in x:
        return "ids"
    if "palo" in x or "forti" in x or "firewall" in x:
        return "firewall"
    if "crowd" in x or "edr" in x or "endpoint" in x:
        return "edr"
    if "splunk" in x or "qradar" in x or "siem" in x:
        return "siem"

    if "signature_id" in a or "signature" in a:
        return "ids"
    if "destination_ip" in a or "action" in a:
        return "firewall"
    if "detection_id" in a or "threat_name" in a:
        return "edr"

    return "siem"


def _sev(v):
    if v is None:
        return "medium"

    if isinstance(v, (int, float)):
        return sev_map.get(str(int(v)), "medium")

    s = str(v).strip().lower()
    return sev_map.get(s, "medium")


def _ts(v):
    if v is None:
        return datetime.now(timezone.utc).isoformat()

    if isinstance(v, (int, float)):
        try:
            return datetime.fromtimestamp(float(v), tz=timezone.utc).isoformat()
        except Exception:
            return datetime.now(timezone.utc).isoformat()

    s = str(v).strip()
    if not s:
        return datetime.now(timezone.utc).isoformat()

    try:
        if s.endswith("Z"):
            s = s.replace("Z", "+00:00")
        if "T" in s:
            return datetime.fromisoformat(s).astimezone(timezone.utc).isoformat()
        return datetime.fromisoformat(s).replace(tzinfo=timezone.utc).isoformat()
    except Exception:
        return datetime.now(timezone.utc).isoformat()


def normalize_alert(a):
    if not isinstance(a, dict):
        raise TypeError("alert must be a dict")

    s = _src(a)
    m = src_rules.get(s, {})

    aid = _pick(a, m.get("id", [])) or str(uuid.uuid4())
    ts = _ts(_pick(a, m.get("timestamp", [])))
    sev = _sev(_pick(a, m.get("severity", [])))
    cat = _pick(a, m.get("category", [])) or "unknown"

    sip = _pick(a, m.get("src_ip", []))
    dip = _pick(a, m.get("dst_ip", []))
    su = _pick(a, m.get("src_user", []))
    host = _pick(a, m.get("host", []))
    msg = _pick(a, m.get("message", [])) or ""

    return NormalizedAlert(
        alert_id=str(aid),
        source=s,
        timestamp=ts,
        severity=sev,
        category=str(cat),
        src_ip=str(sip) if sip is not None else None,
        dst_ip=str(dip) if dip is not None else None,
        src_user=str(su) if su is not None else None,
        host=str(host) if host is not None else None,
        message=str(msg),
        raw=a,
    )
